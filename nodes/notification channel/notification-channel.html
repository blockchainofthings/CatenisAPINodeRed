<script type="text/javascript">
    RED.nodes.registerType('notification channel', {
        category: 'catenis',
        color: '#a2a7cd',
        defaults: {
            name: { value: "" },
            device: { value: "", type: "catenis device" },
            event: { value: "" },
            state: { value: "connected" }
        },
        inputs:0,
        outputs:1,
        icon: "file.png",
        label: function () {
            return this.name || "notification channel";
        },
        oneditprepare: function () {
            var node = this;
            var eventSelect = $("#node-input-event");
            $.ajax({
                url: "catenis.notificationevents",
                type: "GET",
                success: function(data) {
                    events = data;
                    eventSelect.empty();
                    var event;
                    var option;
                    for (var eventID in events) {
                        if (node.event === eventID) {
                            option = $('<option value="' + eventID + '" selected>' + events[eventID] + '</option>');
                        } else {
                            option = $('<option value="' + eventID + '">' + events[eventID] + '</option>');
                        }
                        option.appendTo(eventSelect);
                    }
                },
                error: function(jqXHR,textStatus,errorThrown) {
                    if (jqXHR.status == 404) {
                        RED.notify("Error - please deploy", "error");
                    } else if (jqXHR.status == 500) {
                        RED.notify("Error - server error", "error");
                    } else if (jqXHR.status == 0) {
                        RED.notify("Error - no response", "error");
                    } else {
                        RED.notify("Error - unexpected response", "error");
                    }
                }
            });
        }
    });
</script>

<script type="text/x-red" data-template-name="notification channel">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-device"><i class="fa fa-microchip"></i> Device</label>
        <input type="text" id="node-input-device">
    </div>
    <div class="form-row">
        <label for="node-input-event"><i class="fa fa-bell"></i> Event</label>
        <select id="node-input-event">
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-state"><i class="fa fa-plug"></i> State</label>
        <select id="node-input-state">
            <option value="connected" selected>Connected</option>
            <option value="disconnected">Disconnected</option>
        </select>
    </div>
</script>

<script type="text/x-red" data-help-name="notification channel">
    <p>Connects with Catenis and receives notification messages for a given event.</p>
    <p>The node can be used in two modes: interactive, and run-time. In interactive mode, the end user clicks on the action button and the notification channel for the given notification event (as specified in the node’s configuration) is open/closed. The button toggles the state of the notification channel from connected to disconnected, and vice-versa.</p>
    <p>In run-time mode, the node receives a message the payload of which is an object that contains the action to be performed, either opening or closing the notification channel for the given notification event (as specified in the node’s configuration).</p>
    <p>The current state of the notification channel (either connected or disconnect) is displayed on the UI using the node’s status control.</p>
    <p>Notification messages are passed through the node’s single output.</p>
</script>
