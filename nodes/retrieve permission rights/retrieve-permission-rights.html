<script type="text/javascript">
    RED.nodes.registerType('retrieve permission right', {
        category: 'catenis',
        color: '#a2a7cd',
        defaults: {
            name: { value: "" },
            device: { value: "", type: "catenis device" },
            eventName: { value: "" }
        },
        inputs:0,
        outputs:1,
        icon: "file.png",
        label: function () {
            return this.name || "retrieve permission right";
        },
        button: {
            enabled: true,
            onclick: function() {
                var node = this;
                $.ajax({
                    url: "catenis.retrievepermissionright/" + this.id,
                    type:"POST",
                    success: function(resp) {
                        RED.notify("Success", "success");
                    },
                    error: function(jqXHR,textStatus,errorThrown) {
                        if (jqXHR.status == 404) {
                            RED.notify("Error - please deploy", "error");
                        } else if (jqXHR.status == 500) {
                            RED.notify("Error - server error", "error");
                        } else if (jqXHR.status == 0) {
                            RED.notify("Error - no response", "error");
                        } else {
                            RED.notify("Error - unexpected response", "error");
                        }
                    }
                });
            }
        },
        oneditprepare: function () {
            var node = this;
            var eventSelect = $("#node-input-eventName");
            $.ajax({
                url: "catenis.permissionevents",
                type: "GET",
                success: function(data) {
                    events = data;
                    eventSelect.empty();
                    var event;
                    var option;
                    for (var eventID in events) {
                        if (node.event === eventID) {
                            option = $('<option value="' + eventID + '" selected>' + eventID + ' - ' + events[eventID] + '</option>');
                        } else {
                            option = $('<option value="' + eventID + '">' + eventID + ' - ' + events[eventID] + '</option>');
                        }
                        option.appendTo(eventSelect);
                    }
                },
                error: function(jqXHR,textStatus,errorThrown) {
                    if (jqXHR.status == 404) {
                        RED.notify("Error - please deploy", "error");
                    } else if (jqXHR.status == 500) {
                        RED.notify("Error - server error", "error");
                    } else if (jqXHR.status == 0) {
                        RED.notify("Error - no response", "error");
                    } else {
                        RED.notify("Error - unexpected response", "error");
                    }
                }
            });
        }
    });
</script>

<script type="text/x-red" data-template-name="retrieve permission right">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-device"><i class="fa fa-microchip"></i> Device</label>
        <input type="text" id="node-input-device">
    </div>
    <div class="form-row">
        <label for="node-input-eventName"><i class="fa fa-bell"></i> Event</label>
        <select id="node-input-eventName">
        </select>
    </div>
</script>

<script type="text/x-red" data-help-name="retrieve permission right">
    <p>Call Catenis API to retrieve permission rights currently set for the specified event.</p>
    <p>The configuration settings (except for Name and Device) are used to set the default for the corresponding parameters of the Catenis API end-point.</p>
    <p>The node can be used in two modes: interactive, and run-time. In interactive mode, the end user clicks on the action button and the Catenis API end-point is called using the default settings (as specified in the node’s configuration).</p>
    <p>In run-time mode, the node receives a message the payload of which is an object from where the parameters are gotten. Any parameter present in the message payload supersedes the default settings (as specified in the node’s configuration).</p>
    <p>The data returned from a successful call to the Catenis API end-point are passed through the node’s single output.</p>
</script>
